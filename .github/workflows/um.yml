name: update-module-options-workflow

on:
  push:
    branches:
      - ci/module-list

  workflow_dispatch:
    inputs:
      yamlFilePath:
        type: string
        description: 'Path to the onboarding workflow YAML file (e.g., .github\actions\templates\testing\onboarding-workflow.yml)'
        required: true
      registryUrl:
        type: string
        description: 'URL of the MCR registry (default: https://mcr.microsoft.com/v2)'
        default: 'https://mcr.microsoft.com/v2'
        required: false
      moduleRepoPath:
        type: string
        description: 'Path to the module repository in the MCR registry (default: bicep/avm/res)'
        default: 'bicep/avm/res'
        required: false

  schedule:
    - cron: "0 0 * * *" # Runs daily at midnight UTC

permissions:
  id-token: write
  contents: write
  statuses: write
  actions: write

jobs:
  update_modules:
    runs-on: ubuntu-latest

    steps:
      - name: Generate App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{  vars.VERSION_BUMPER_APPID  }}
          private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Define inputs
        id: define_inputs
        shell: pwsh
        run: |
          $yamlFilePath = "${{ github.event.inputs.yamlFilePath }}"
          $registryUrl = "${{ github.event.inputs.registryUrl }}"
          $moduleRepoPath = "${{ github.event.inputs.moduleRepoPath }}"
          echo "::set-output name=yamlFilePath::$yamlFilePath"
          echo "::set-output name=registryUrl::$registryUrl"
          echo "::set-output name=moduleRepoPath::$moduleRepoPath"

      - name: Create and checkout feature branch
        shell: pwsh
        run: |
            git checkout ci/module-list
            git pull origin ci/module-list
            git branch ci/update-onboarding-workflow || Write-Output "Branch already exists locally or remotely."
            git checkout ci/update-onboarding-workflow
            git branch

      - name: Fetch module list from MCR
        id: fetch_modules
        run: |
          $ListOutput = ./utilities/tools/Get-ModuleList.ps1
          echo "::set-output name=moduleList::$ListOutput"
        shell: pwsh

      - name: Update Onboarding Workflow
        run: |
          $moduleList = "${{ steps.fetch_modules.outputs.moduleList }}" | ConvertFrom-Json
          $updateworkflow = ./utilities/tools/Update-ModuleList01.ps1 -yamlFilePath '.github\workflows\onboarding-workflow.yml' -newOptions "$moduleList"
        shell: pwsh

      # - name: Update Onboarding Workflow
      #   run: |
      #     Write-Output $ListOutput
      #     $updateworkflow = ./utilities/tools/Update-ModuleList.ps1  -yamlFilePath '.github\workflows\onboarding-workflow.yml' -newOptions $ListOutput
      #   shell: pwsh

      - name: Push changes to feature branch
        env:
          token: ${{ steps.app-token.outputs.token }}
        shell: pwsh
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@gtest.com"
          git add .
          git commit -m "Update onboarding workflow module options"
          git push origin ci/update-onboarding-workflow

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
              token: ${{ secrets.GITHUB_TOKEN }}
              branch: ci/update-onboarding-workflow
              base: main
              title: "Update Onboarding Workflow"
              body: "This PR updates the onboarding workflow with the latest module options."
